@* filepath: d:\Learning .net\WaktuSolat\WaktuSolat\Views\Home\Index.cshtml *@
@model WaktuSolat.Models.WaktuSolatEntity
@{
    var allZones = ViewBag.AllZones as List<WaktuSolat.Models.ZoneGroup> ?? new List<WaktuSolat.Models.ZoneGroup>();
    var selectedZone = (ViewBag.SelectedZone as string ?? "WLY01").ToUpper();
}

@section Styles {
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
    <style>
        .prayer-card { transition: .2s ease; border: 1px solid rgba(0,0,0,.06); }
        .prayer-card:hover { transform: translateY(-3px); }
        .next-prayer { border-color: #0d6efd !important; box-shadow: 0 0 0 .25rem rgba(13,110,253,.15); }
        .next-badge { background: linear-gradient(90deg,#0d6efd,#6ea8fe); }
        .accent-pill { background: #f4c5421a; color: #8a6d1d; border: 1px solid #f4c54255; }
    </style>
}

<div class="row justify-content-center">
    <div class="col-12 col-lg-10">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                    <h1 class="h2 mb-0">Waktu Solat</h1>
                    <span class="badge bg-secondary fs-6 ms-2">Hari Ini</span>
                    <span id="nextBadge" class="badge next-badge fs-6 ms-auto d-none">
                        <i class="bi bi-clock-history me-1"></i>
                        <span id="nextLabel">Seterusnya</span> â€¢ <span id="countdown">--:--</span>
                    </span>
                </div>

                @if (!string.IsNullOrEmpty(ViewBag.Error))
                {
                    <div class="alert alert-danger" role="alert">
                        <strong>Ralat:</strong> @ViewBag.Error
                    </div>
                }

                <div class="row g-3 align-items-end mb-4">
                    <div class="col-12 col-md-8">
                        <label for="zoneSelect" class="form-label fw-semibold">Pilih Zon</label>
                        <select id="zoneSelect" class="form-select" onchange="changeZone()">
                            <option value="">-- Pilih Zon --</option>
                            @foreach (var group in allZones)
                            {
                                <optgroup label="@group.State">
                                    @foreach (var zone in group.Zones)
                                    {
                                        <option value="@zone.Value" selected="@(zone.Value.Equals(selectedZone, StringComparison.OrdinalIgnoreCase))">
                                            @zone.Text
                                        </option>
                                    }
                                </optgroup>
                            }
                        </select>
                    </div>
                    <div class="col-12 col-md-4 text-md-end">
                        <button type="button" class="btn btn-outline-primary" onclick="goToday()">
                            <i class="bi bi-calendar-day me-1"></i> Hari Ini
                        </button>
                    </div>
                </div>

                @if (Model != null)
                {
                    <div class="row g-3 mb-4">
                        <div class="col-12 col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="text-muted small mb-1">Tarikh Masehi</div>
                                    <div class="fs-5 fw-semibold">@Model.TarikhMasehi</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="text-muted small mb-1">Tarikh Hijrah</div>
                                    <div class="fs-5 fw-semibold">@Model.TarikhHijrah</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                <div class="fw-semibold">@Model.czone (@Model.cbearing)</div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3" id="prayerGrid">
                        <div class="col-6 col-md-3">
                            <div class="card prayer-card text-center" data-name="Imsak" data-time="@Model.Imsak">
                                <div class="card-body">
                                    <div class="text-muted small mb-1"><i class="bi bi-alarm me-1"></i> Imsak</div>
                                    <div class="display-6 fs-3 fw-bold">@Model.Imsak</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card prayer-card text-center" data-name="Subuh" data-time="@Model.Subuh">
                                <div class="card-body">
                                    <div class="text-muted small mb-1"><i class="bi bi-sunrise me-1"></i> Subuh</div>
                                    <div class="display-6 fs-3 fw-bold">@Model.Subuh</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card prayer-card text-center" data-name="Syuruk" data-time="@Model.Syuruk">
                                <div class="card-body">
                                    <div class="text-muted small mb-1"><i class="bi bi-sunrise-fill me-1"></i> Syuruk</div>
                                    <div class="display-6 fs-3 fw-bold">@Model.Syuruk</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card prayer-card text-center" data-name="Dhuha" data-time="@Model.Dhuha">
                                <div class="card-body">
                                    <div class="text-muted small mb-1"><i class="bi bi-brightness-high me-1"></i> Dhuha</div>
                                    <div class="display-6 fs-3 fw-bold">@Model.Dhuha</div>
                                </div>
                            </div>
                        </div>

                        <div class="col-6 col-md-3">
                            <div class="card prayer-card text-center" data-name="Zohor" data-time="@Model.Zohor">
                                <div class="card-body">
                                    <div class="text-muted small mb-1"><i class="bi bi-sun me-1"></i> Zohor</div>
                                    <div class="display-6 fs-3 fw-bold">@Model.Zohor</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card prayer-card text-center" data-name="Asar" data-time="@Model.Asar">
                                <div class="card-body">
                                    <div class="text-muted small mb-1"><i class="bi bi-cloud-sun me-1"></i> Asar</div>
                                    <div class="display-6 fs-3 fw-bold">@Model.Asar</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card prayer-card text-center" data-name="Maghrib" data-time="@Model.Maghrib">
                                <div class="card-body">
                                    <div class="text-muted small mb-1"><i class="bi bi-sunset me-1"></i> Maghrib</div>
                                    <div class="display-6 fs-3 fw-bold">@Model.Maghrib</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card prayer-card text-center" data-name="Isyak" data-time="@Model.Isyak">
                                <div class="card-body">
                                    <div class="text-muted small mb-1"><i class="bi bi-moon-stars me-1"></i> Isyak</div>
                                    <div class="display-6 fs-3 fw-bold">@Model.Isyak</div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function changeZone() {
            const select = document.getElementById('zoneSelect');
            const selectedZone = select.value;
            if (!selectedZone) return;
            select.disabled = true;
            select.classList.add('disabled');
            window.location.href = `/?zone=${selectedZone}`;
        }
        function goToday() {
            const url = new URL(window.location.href);
            const zone = document.getElementById('zoneSelect')?.value || '';
            url.searchParams.set('zone', zone);
            window.location.href = url.toString();
        }

        // Helpers to parse time strings like "05:40", "05:40:00", or "5:40 AM"
        function parsePrayerTimeToDate(t) {
            if (!t) return null;
            t = t.trim();
            const now = new Date();
            // Try HH:mm[:ss]
            let m = t.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
            if (m) {
                const h = parseInt(m[1], 10), min = parseInt(m[2], 10), s = parseInt(m[3] || '0', 10);
                const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, min, s, 0);
                return d;
            }
            // Try h:mm AM/PM
            m = t.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
            if (m) {
                let h = parseInt(m[1], 10);
                const min = parseInt(m[2], 10);
                const ap = m[3].toUpperCase();
                if (ap === 'PM' && h < 12) h += 12;
                if (ap === 'AM' && h === 12) h = 0;
                const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, min, 0, 0);
                return d;
            }
            return null;
        }

        function findNextPrayer() {
            const cards = Array.from(document.querySelectorAll('#prayerGrid .prayer-card'));
            const now = new Date();
            const items = cards.map(c => ({
                el: c,
                name: c.getAttribute('data-name'),
                timeStr: c.getAttribute('data-time'),
                date: parsePrayerTimeToDate(c.getAttribute('data-time'))
            })).filter(x => !!x.date);

            // sort by time
            items.sort((a, b) => a.date - b.date);

            // find first time > now, else none
            let next = items.find(x => x.date > now);

            // If all passed, consider next day Imsak (optional). Here we just return null.
            if (!next) return null;

            // Highlight card
            cards.forEach(c => c.classList.remove('next-prayer'));
            next.el.classList.add('next-prayer');

            return next;
        }

        function formatCountdown(ms) {
            if (ms < 0) ms = 0;
            const s = Math.floor(ms / 1000);
            const hh = Math.floor(s / 3600).toString().padStart(2, '0');
            const mm = Math.floor((s % 3600) / 60).toString().padStart(2, '0');
            const ss = (s % 60).toString().padStart(2, '0');
            return `${hh}:${mm}:${ss}`;
        }

        function startCountdown() {
            const badge = document.getElementById('nextBadge');
            const label = document.getElementById('nextLabel');
            const countdown = document.getElementById('countdown');

            function tick() {
                const next = findNextPrayer();
                if (!next) {
                    badge.classList.add('d-none');
                    return;
                }
                badge.classList.remove('d-none');
                label.textContent = `Seterusnya: ${next.name}`;
                const now = new Date();
                const diff = next.date - now;
                countdown.textContent = formatCountdown(diff);
            }

            tick();
            setInterval(tick, 1000);
        }

        document.addEventListener('DOMContentLoaded', startCountdown);
    </script>
}